<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>연차·미사용수당 파이썬 엔진 (Pyodide 데모)</title>

  <!-- 기존 공통 스타일 -->
  <link rel="stylesheet" href="/static/style.css" />

  <!-- Pyodide 로더 -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

  <style>
    .field { display:flex; flex-direction:column; gap:4px; margin-bottom:8px; }
    .numeric { text-align:right; }
    .status { font-size:0.9rem; color:#555; margin-top:4px; }
    .danger { color:#c8352d; }
    .result-grid {
      display:flex; flex-direction:column; gap:6px; font-size:0.92rem;
    }
    .result-item {
      display:flex; align-items:baseline; gap:8px; flex-wrap:wrap;
    }
    .result-label { min-width:200px; font-weight:600; }
    .result-value {
      margin-left:auto; text-align:right; font-variant-numeric:tabular-nums;
    }
    .highlight { font-size:1.05rem; font-weight:700; }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="shell">
      <h1>연차·미사용수당 파이썬 엔진 (Pyodide 데모)</h1>
      <p class="sub">
        <b>annual_engine.py</b>에 있는 파이썬 로직을 <b>서버 없이 브라우저 안</b>에서 돌려보는 테스트 페이지입니다.<br>
        나중에 FastAPI 서버로 옮겨갈 때도 같은 모듈을 그대로 재사용할 수 있도록 구성했습니다.
      </p>
    </div>
  </header>

  <main>
    <section class="section">
      <h2>1. Pyodide 상태</h2>
      <p class="muted">
        페이지가 열리면 Pyodide가 자동 로딩되고, <code>annual_engine.py</code>를 불러옵니다.
      </p>
      <div id="pyStatus" class="status">Pyodide 로딩 중...</div>
    </section>

    <section class="section">
      <h2>2. 입력값</h2>

      <div class="card">
        <h3 style="margin-top:0;">2-1. 규정 세트 & 근속·출근 요약</h3>
        <div class="grid three">
          <div class="field">
            <label for="ruleId">규정 세트</label>
            <select id="ruleId">
              <option value="law_basic">법정 기본형 (근로기준법 단순)</option>
              <option value="gw_school_cba">학교근무자 CBA 예시</option>
              <option value="gw_institute_cba">기관근무자 CBA 예시</option>
              <option value="gw_wage_guideline">통상임금 지침형 (연차일수 외부산정)</option>
              <option value="custom">커스텀</option>
            </select>
          </div>
          <div class="field">
            <label for="serviceYears">근속연수(년, 대략)</label>
            <input id="serviceYears" type="number" step="0.1" value="1.0" class="numeric" />
          </div>
          <div class="field">
            <label for="fullYears">완전년수(정수)</label>
            <input id="fullYears" type="number" step="1" value="1" class="numeric" />
          </div>
        </div>

        <div class="grid three">
          <div class="field">
            <label for="attendanceRate">출근율(%)</label>
            <input id="attendanceRate" type="number" step="0.1" value="98.5" class="numeric" />
          </div>
          <div class="field">
            <label for="fullMonths">월 개근 개월수</label>
            <input id="fullMonths" type="number" step="1" value="12" class="numeric" />
          </div>
          <div class="field">
            <label>입사·기준일 (문자열로만 전달)</label>
            <input id="hireDate" type="text" placeholder="예: 2024-03-01" />
            <input id="baseDate" type="text" placeholder="예: 2025-03-01" style="margin-top:4px;" />
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0;">2-2. 임금 정보</h3>
        <div class="grid three">
          <div class="field">
            <label for="wageType">임금형태</label>
            <select id="wageType">
              <option value="hourly">시급</option>
              <option value="daily">일급</option>
              <option value="monthly" selected>월급</option>
            </select>
          </div>
          <div class="field">
            <label for="wageAmount">금액 (원)</label>
            <input id="wageAmount" type="number" step="10" value="2300000" class="numeric" />
          </div>
          <div class="field">
            <label for="hoursPerDay">1일 소정근로시간</label>
            <input id="hoursPerDay" type="number" step="0.5" value="8" class="numeric" />
          </div>
        </div>

        <div class="grid two">
          <div class="field">
            <label for="monthlyWorkDays">월 소정근로일수</label>
            <input id="monthlyWorkDays" type="number" step="0.1" value="20.5" class="numeric" />
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0;">2-3. 연차 부여·사용 일수</h3>
        <div class="grid two">
          <div class="field">
            <label for="grantedDays">부여 연차일수</label>
            <input id="grantedDays" type="number" step="0.5" value="26" class="numeric" />
          </div>
          <div class="field">
            <label for="usedDays">사용 연차일수</label>
            <input id="usedDays" type="number" step="0.5" value="10.5" class="numeric" />
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <button type="button" class="btn primary" id="btnRun" disabled>
          파이썬 엔진으로 계산
        </button>
      </div>
    </section>

    <section class="section">
      <h2>3. 결과 (annual_engine.full_pipeline)</h2>
      <div class="card">
        <div class="result-grid">
          <div class="result-item">
            <div class="result-label">규정 세트</div>
            <div class="result-value" id="resRuleName">-</div>
          </div>
          <div class="result-item">
            <div class="result-label">추천 연차일수</div>
            <div class="result-value" id="resSuggestedDays">-</div>
          </div>
          <div class="result-item">
            <div class="result-label">추천 설명</div>
            <div class="result-value" id="resSuggestedDesc" style="text-align:left;">-</div>
          </div>
          <div class="result-item">
            <div class="result-label">부여 / 사용 / 미사용 일수</div>
            <div class="result-value" id="resDaysDetail">-</div>
          </div>
          <div class="result-item">
            <div class="result-label">1일 통상임금(원단위)</div>
            <div class="result-value" id="resDailyWage">-</div>
          </div>
          <div class="result-item">
            <div class="result-label">미사용 연차수당 (계산상, 원단위)</div>
            <div class="result-value" id="resPayoutRaw">-</div>
          </div>
          <div class="result-item">
            <div class="result-label">미사용 연차수당 (절사 적용)</div>
            <div class="result-value highlight" id="resPayoutRounded">-</div>
          </div>
          <div class="result-item">
            <div class="result-label">절사 규칙</div>
            <div class="result-value" id="resRoundingRule">-</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ----------------------------
    // Pyodide 초기화
    // ----------------------------
    let pyodide = null;
    let pyReady = false;

    async function initPyodide() {
      const statusEl = document.getElementById("pyStatus");
      try {
        statusEl.textContent = "Pyodide 로딩 중...";
        pyodide = await loadPyodide();

        // annual_engine.py 파일을 같은 폴더에 두었다고 가정
        const code = await (await fetch("annual_engine.py")).text();
        await pyodide.runPythonAsync(code);

        pyReady = true;
        statusEl.textContent = "Pyodide + annual_engine.py 로딩 완료. 계산 가능.";
        document.getElementById("btnRun").disabled = false;
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Pyodide 로딩 실패. 콘솔 오류를 확인하세요.";
        statusEl.classList.add("danger");
      }
    }

    initPyodide();

    // ----------------------------
    // 버튼 클릭 → full_pipeline 호출
    // ----------------------------
    document.getElementById("btnRun").addEventListener("click", async () => {
      if (!pyReady) {
        alert("Pyodide가 아직 준비되지 않았습니다.");
        return;
      }

      const ruleId = document.getElementById("ruleId").value;

      const serviceDict = {
        hire_date: document.getElementById("hireDate").value || "",
        base_date: document.getElementById("baseDate").value || "",
        service_years: parseFloat(document.getElementById("serviceYears").value || "0"),
        full_years: parseInt(document.getElementById("fullYears").value || "0"),
        attendance_rate: parseFloat(document.getElementById("attendanceRate").value || "0"),
        full_months: parseInt(document.getElementById("fullMonths").value || "0"),
      };

      const wageDict = {
        wage_type: document.getElementById("wageType").value,
        wage_amount: parseFloat(document.getElementById("wageAmount").value || "0"),
        hours_per_day: parseFloat(document.getElementById("hoursPerDay").value || "0"),
        monthly_work_days: parseFloat(document.getElementById("monthlyWorkDays").value || "0"),
      };

      const granted = parseFloat(document.getElementById("grantedDays").value || "0");
      const used = parseFloat(document.getElementById("usedDays").value || "0");

      try {
        // JS 딕셔너리를 Pyodide로 넘기기
        const servicePy = pyodide.toPy(serviceDict);
        const wagePy = pyodide.toPy(wageDict);
        pyodide.globals.set("svc_js", servicePy);
        pyodide.globals.set("wage_js", wagePy);

        const result = await pyodide.runPythonAsync(`
from annual_engine import full_pipeline
full_pipeline("${ruleId}", svc_js, wage_js, ${granted}, ${used})
        `);

        const res = result.toJs({ deep: true });

        // 결과 반영
        document.getElementById("resRuleName").textContent = res.rule.name || "-";

        const sug = res.suggestion || {};
        document.getElementById("resSuggestedDays").textContent =
          (sug.suggested_days === null || sug.suggested_days === undefined)
            ? "직접 입력 필요"
            : sug.suggested_days.toString() + " 일";
        document.getElementById("resSuggestedDesc").textContent = sug.description || "-";

        const pay = res.payout || {};
        document.getElementById("resDaysDetail").textContent =
          `부여 ${pay.granted_days ?? 0}일 / 사용 ${pay.used_days ?? 0}일 / 미사용 ${pay.unused_days ?? 0}일`;

        document.getElementById("resDailyWage").textContent =
          pay.daily_wage_raw ? Math.round(pay.daily_wage_raw).toLocaleString("ko-KR") + " 원" : "-";

        document.getElementById("resPayoutRaw").textContent =
          pay.payout_raw ? Math.round(pay.payout_raw).toLocaleString("ko-KR") + " 원" : "-";

        document.getElementById("resPayoutRounded").textContent =
          pay.payout_rounded ? Math.round(pay.payout_rounded).toLocaleString("ko-KR") + " 원" : "-";

        document.getElementById("resRoundingRule").textContent =
          `${pay.rounding_step ?? 10}원 단위 ${pay.rounding_mode || "floor"} (1원 절삭)`;
      } catch (e) {
        console.error(e);
        alert("파이썬 엔진 실행 중 오류가 발생했습니다. 콘솔을 확인하세요.");
      }
    });
  </script>
</body>
</html>
